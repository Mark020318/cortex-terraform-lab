name: Cortex CLI Code Scan (Changed Files Only)

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  # ğŸŸ¢ 1. ä½¿ç”¨å®˜æ–¹ç¯„ä¾‹ä¸­çš„å°ç£å€ API ç¶²å€
  CORTEX_API_URL: https://api-twes.xdr.tw.paloaltonetworks.com
  
  # GitHub Secrets
  CORTEX_API_KEY_ID: ${{ secrets.CORTEX_API_KEY_ID }}
  CORTEX_API_KEY: ${{ secrets.CORTEX_API_KEY_SECRET }}

jobs:
  cortex-code-scan:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read
      security-events: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # âš ï¸ å¿…é ˆè¨­ç‚º 0ï¼Œå¦å‰‡ git diff æŠ“ä¸åˆ°æ­·å²ç´€éŒ„

      - name: Install jq
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y jq

      # ğŸŸ¢ 2. æ‰¾å‡ºå“ªäº›æª”æ¡ˆè¢«ä¿®æ”¹äº†
      - name: Collect changed files
        id: changes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -eux
          mkdir -p _cortex_changed
          rm -f changed_files.txt

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR event detected"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            OWNER_REPO="${{ github.repository }}"
            
            # é€é GitHub API æŠ“å– PR çš„è®Šæ›´æª”æ¡ˆ (æ”¯æ´åˆ†é )
            page=1
            while true; do
              resp=$(curl -sS -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${OWNER_REPO}/pulls/${PR_NUMBER}/files?per_page=100&page=${page}")
              count=$(echo "$resp" | jq 'length')
              [ "$count" -eq 0 ] && break
              echo "$resp" | jq -r '.[].filename' >> changed_files.txt
              page=$((page+1))
            done
          else
            echo "Push / Manual event detected"
            # æ¯”å°é€™ä¸€æ¬¡ Commit èˆ‡ä¸Šä¸€æ¬¡ Commit çš„å·®ç•°
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              git diff --name-only HEAD~1 HEAD > changed_files.txt
            else
              git ls-files > changed_files.txt
            fi
          fi

          # å»é™¤é‡è¤‡ä¸¦é¡¯ç¤º
          sort -u changed_files.txt -o changed_files.txt || true
          echo "=== Changed Files List ==="
          cat changed_files.txt || true

      # ğŸŸ¢ 3. æŠŠè®Šæ›´çš„æª”æ¡ˆè¤‡è£½åˆ° _cortex_changed è³‡æ–™å¤¾
      - name: Prepare scan directory
        run: |
          set -eux
          
          # è®€å–æ¸…å–®ä¸¦è¤‡è£½æª”æ¡ˆ
          while read -r file; do
            if [ -f "$file" ]; then
              # ä¿æŒç›®éŒ„çµæ§‹è¤‡è£½ (ä¾‹å¦‚ src/main.js -> _cortex_changed/src/main.js)
              mkdir -p "_cortex_changed/$(dirname "$file")"
              cp "$file" "_cortex_changed/$file"
            fi
          done < changed_files.txt || true

          # æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆï¼Œå¦‚æœæ²’æœ‰(ä¾‹å¦‚åªåˆªé™¤æª”æ¡ˆ)ï¼Œå»ºç«‹ä¸€å€‹ç©ºæª”æ¡ˆé¿å…æƒæå™¨å ±éŒ¯
          FILE_COUNT=$(find _cortex_changed -type f | wc -l || true)
          echo "Files prepared for scan: $FILE_COUNT"

          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "No files to scan. Creating placeholder."
            echo "placeholder" > _cortex_changed/.cortex_placeholder
          fi

      # æ¸…é™¤èˆŠè¨­å®š (Support å»ºè­°)
      - name: Clean Cortex CLI Config
        run: |
          rm -rf ~/.cortexcli/APPSEC

      - name: Download cortexcli
        run: |
          set -eux
          # ä½¿ç”¨ env ä¸­çš„æ­£ç¢ºç¶²å€
          crtx_resp=$(curl -sS "${CORTEX_API_URL}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" \
            -H "x-xdr-auth-id: ${CORTEX_API_KEY_ID}" \
            -H "Authorization: ${CORTEX_API_KEY}")

          crtx_url=$(echo "$crtx_resp" | jq -r ".signed_url")
          
          if [ -z "$crtx_url" ] || [ "$crtx_url" = "null" ]; then
            echo "Error: Failed to get signed URL"
            exit 1
          fi

          curl -sS -o cortexcli "$crtx_url"
          chmod +x cortexcli

      # ğŸŸ¢ 4. åŸ·è¡Œæƒæ (é—œéµï¼šæŒ‡å®š directory ç‚º _cortex_changed)
      - name: Run Cortex CLI Code Scan (Incremental)
        run: |
          set -eux
          OUTPUT_PATH="${{ github.workspace }}/result.sarif"

          ./cortexcli \
            --api-base-url "${CORTEX_API_URL}" \
            --api-key "${CORTEX_API_KEY}" \
            --api-key-id "${CORTEX_API_KEY_ID}" \
            code scan \
            --directory "${{ github.workspace }}/_cortex_changed" \
            --repo-id "${{ github.repository }}" \
            --branch "${{ github.ref_name }}" \
            --source "GITHUB_ACTIONS" \
            --create-repo-if-missing \
            --upload-mode upload \
            --output sarif \
            --output-file-path "$OUTPUT_PATH"

          test -f "$OUTPUT_PATH"

      # é™¤éŒ¯ç”¨ï¼šé¡¯ç¤ºç‰ˆæœ¬
      - name: Check APPSEC Version
        if: always()
        run: |
          if [ -f ~/.cortexcli/APPSEC/version.json ]; then
            cat ~/.cortexcli/APPSEC/version.json
          fi

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: result.sarif
