name: Cortex CLI Code Scan (changed files only)

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  CORTEX_API_KEY_ID: ${{ secrets.CORTEX_API_KEY_ID }}
  CORTEX_API_KEY: ${{ secrets.CORTEX_API_KEY_SECRET }}
  CORTEX_API_URL: ${{ secrets.CORTEX_API_BASE_URL }}

jobs:
  cortex-code-scan:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read
      security-events: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # å¿…é ˆï¼Œå¦å‰‡æŠ“ä¸åˆ° diff

      - name: Install jq
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y jq

      # ğŸ”¹ ä¾äº‹ä»¶é¡å‹æ”¶é›†ã€Œè®Šå‹•æª”æ¡ˆæ¸…å–®ã€
      - name: Collect changed files
        id: changes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -eux

          mkdir -p _cortex_changed
          rm -f changed_files.txt

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR event detected"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            OWNER_REPO="${{ github.repository }}"

            page=1
            while true; do
              resp=$(curl -sS -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${OWNER_REPO}/pulls/${PR_NUMBER}/files?per_page=100&page=${page}")
              
              count=$(echo "$resp" | jq 'length')
              [ "$count" -eq 0 ] && break

              echo "$resp" | jq -r '.[].filename' >> changed_files.txt
              page=$((page+1))
            done

          else
            echo "Push / manual event detected"
            
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              git diff --name-only HEAD~1 HEAD > changed_files.txt
            else
              git ls-files > changed_files.txt
            fi
          fi

          sort -u changed_files.txt -o changed_files.txt || true
          echo "Changed files:"
          cat changed_files.txt || true

      # ğŸ”¹ å»ºç«‹å¯¦éš›è¦æƒæçš„ç›®éŒ„
      - name: Prepare scan directory
        run: |
          set -eux

          while read -r file; do
            if [ -f "$file" ]; then
              mkdir -p "_cortex_changed/$(dirname "$file")"
              cp "$file" "_cortex_changed/$file"
            fi
          done < changed_files.txt || true

          FILE_COUNT=$(find _cortex_changed -type f | wc -l || true)
          echo "Files prepared for scan: $FILE_COUNT"

          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "No files to scan (deletions only). Creating placeholder."
            echo "placeholder" > _cortex_changed/.cortex_placeholder
          fi

          find _cortex_changed -type f

      # ğŸ”´ [æ–°å¢ 1] ä¾ç…§ Support è¦æ±‚ï¼Œåœ¨ä¸‹è¼‰å‰å…ˆæ¸…é™¤ç›¸é—œè³‡æ–™å¤¾
      # ç›®çš„ï¼šé¿å…èˆŠçš„ APPSEC æ¨¡çµ„æ®˜ç•™å°è‡´ç‰ˆæœ¬è¡çª
      - name: Clean Cortex CLI Config (Support Request)
        run: |
          set -eux
          echo "Performing clean reset as requested by support..."
          rm -rf ~/.cortexcli/APPSEC

      - name: Download cortexcli
        run: |
          set -eux

          # ä¸‹è¼‰ CLI å·¥å…·
          crtx_resp=$(curl -sS "${CORTEX_API_URL}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" \
            -H "x-xdr-auth-id: ${CORTEX_API_KEY_ID}" \
            -H "Authorization: ${CORTEX_API_KEY}")

          crtx_url=$(echo "$crtx_resp" | jq -r ".signed_url")
          [ -z "$crtx_url" ] && exit 1

          curl -sS -o cortexcli "$crtx_url"
          chmod +x cortexcli
          
          # åŸ·è¡ŒåŸºç¤ç‰ˆæœ¬æª¢æŸ¥
          ./cortexcli --version

          # ğŸ”´ [æ–°å¢ 2] ä¾ç…§æ¾å€«è¦æ±‚ï¼Œæª¢æŸ¥ APPSEC æ¨¡çµ„ç‹€æ³
          # å› ç‚º ./cortexcli æ˜¯æª”æ¡ˆä¸æ˜¯è³‡æ–™å¤¾ï¼Œä¸èƒ½ç”¨ä»–åŸæœ¬çš„è·¯å¾‘
          # æ”¹ç‚ºæª¢æŸ¥å®¶ç›®éŒ„ä¸‹çš„è¨­å®šæª”ï¼Œè‹¥æœ‰æ›´æ–°ï¼Œæ™‚é–“æˆ³è¨˜æœƒæ˜¯æ–°çš„
          echo "=== Checking APPSEC module details for verification ==="
          if [ -d "$HOME/.cortexcli/APPSEC" ]; then
             ls -lR "$HOME/.cortexcli/APPSEC"
          else
             echo "APPSEC directory not created yet (it will be created during the scan step)."
          fi

      - name: Run Cortex CLI Code Scan (changed files only)
        run: |
          set -eux

          OUTPUT_PATH="${{ github.workspace }}/result.sarif"

          ./cortexcli \
            --api-base-url "${CORTEX_API_URL}" \
            --api-key "${CORTEX_API_KEY}" \
            --api-key-id "${CORTEX_API_KEY_ID}" \
            code scan \
            --directory "${{ github.workspace }}/_cortex_changed" \
            --repo-id "${{ github.repository }}" \
            --branch "${{ github.ref_name }}" \
            --source "GITHUB_ACTIONS" \
            --create-repo-if-missing \
            --upload-mode upload \
            --output sarif \
            --output-file-path "$OUTPUT_PATH"

          test -f "$OUTPUT_PATH"

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: result.sarif
