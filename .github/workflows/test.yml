name: Cortex CLI Code Scan (Auto-Discovery)

on:
  push:
    branches:
      - '**'
  pull_request:
  workflow_dispatch:

env:
  # 台灣區 API
  CORTEX_API_URL: https://api-twes.xdr.tw.paloaltonetworks.com
  CORTEX_API_KEY_ID: ${{ secrets.CORTEX_API_KEY_ID }}
  CORTEX_API_KEY: ${{ secrets.CORTEX_API_KEY_SECRET }}

jobs:
  # Job 1: 自動探索有哪些資料夾
  discover-targets:
    runs-on: ubuntu-latest
    outputs:
      # 將找出來的 JSON 清單傳給下一個 Job
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Discover Directories and Root Files
        id: set-matrix
        run: |
          # 1. 找出所有第一層的資料夾 (排除 .git, .github 等隱藏資料夾)
          # 使用 find 指令只找當前目錄下的資料夾
          DIRS=$(find . -maxdepth 1 -mindepth 1 -type d -not -path '*/.*' -printf '%P\n' | sort)
          
          # 2. 轉換成 JSON 陣列
          # 例如: ["backend", "frontend", "terraform"]
          JSON_ARRAY=$(echo "$DIRS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          # 3. 檢查是否有「根目錄散落檔案」(非資料夾的檔案)
          ROOT_FILES=$(find . -maxdepth 1 -type f -not -path '*/.*' | head -n 1)
          
          if [ -n "$ROOT_FILES" ]; then
            echo "Found files in root directory. Adding _ROOT_FILES_ task."
            # 把一個特殊的標記 "_ROOT_FILES_" 加進去陣列
            JSON_ARRAY=$(echo "$JSON_ARRAY" | jq -c '. + ["_ROOT_FILES_"]')
          fi
          
          echo "Final Matrix: $JSON_ARRAY"
          
          # 4. 設定 Output 變數
          echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT

  # Job 2: 平行掃描 (接收上面的清單)
  cortex-scan-dynamic:
    needs: discover-targets  # 必須等探索完成
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false # 讓彼此不互相影響，一個失敗其他繼續跑
      matrix:
        # 這裡會自動填入上面找到的清單，例如 ["src", "tf", "_ROOT_FILES_"]
        target: ${{ fromJson(needs.discover-targets.outputs.matrix) }}

    name: Scan (${{ matrix.target }})
    
    permissions:
      contents: read
      pull-requests: read
      security-events: write
      actions: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Clean Config
        run: rm -rf ~/.cortexcli/APPSEC

      - name: Download cortexcli
        run: |
          set -eux
          crtx_resp=$(curl -sS "${CORTEX_API_URL}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" \
            -H "x-xdr-auth-id: ${CORTEX_API_KEY_ID}" \
            -H "Authorization: ${CORTEX_API_KEY}")

          crtx_url=$(echo "$crtx_resp" | jq -r ".signed_url")
          
          if [ -z "$crtx_url" ] || [ "$crtx_url" = "null" ]; then
            echo "Error: Failed to get signed URL"
            exit 1
          fi

          curl -sS -o cortexcli "$crtx_url"
          chmod +x cortexcli

      - name: Run Cortex CLI Code Scan
        run: |
          set -eux
          TARGET_NAME="${{ matrix.target }}"
          SCAN_DIR=""
          
          if [ "$TARGET_NAME" == "_ROOT_FILES_" ]; then
            echo "處理根目錄散落檔案..."
            # 建立暫存資料夾掃描根目錄檔案，避免重複掃描子資料夾
            mkdir -p _temp_root_scan
            find . -maxdepth 1 -type f -not -path '*/.*' -exec cp {} _temp_root_scan/ \;
            SCAN_DIR="_temp_root_scan"
            echo "已將根目錄檔案複製到 $SCAN_DIR 進行隔離掃描"
          else
            echo "處理資料夾: $TARGET_NAME"
            SCAN_DIR="$TARGET_NAME"
          fi
          
          # 執行掃描 (已移除 --scan-id-tag)
          ./cortexcli \
            --api-base-url "${CORTEX_API_URL}" \
            --api-key "${CORTEX_API_KEY}" \
            --api-key-id "${CORTEX_API_KEY_ID}" \
            code scan \
            --directory "$SCAN_DIR" \
            --repo-id "${{ github.repository }}" \
            --branch "${{ github.ref_name }}" \
            --source "GITHUB_ACTIONS" \
            --create-repo-if-missing \
            --upload-mode upload
