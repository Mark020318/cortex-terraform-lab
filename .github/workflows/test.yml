name: Cortex CLI Code Scan (Auto-Discovery)

on:
  push:
    branches:
      - '**'
  pull_request:
  workflow_dispatch:

env:
  CORTEX_API_URL: https://api-twes.xdr.tw.paloaltonetworks.com
  CORTEX_API_KEY_ID: ${{ secrets.CORTEX_API_KEY_ID }}
  CORTEX_API_KEY: ${{ secrets.CORTEX_API_KEY_SECRET }}

jobs:
  # ğŸ•µï¸â€â™‚ï¸ ç¬¬ä¸€éšæ®µï¼šè‡ªå‹•æ¢ç´¢æœ‰å“ªäº›è³‡æ–™å¤¾
  discover-targets:
    runs-on: ubuntu-latest
    outputs:
      # å°‡æ‰¾å‡ºä¾†çš„ JSON æ¸…å–®å‚³çµ¦ä¸‹ä¸€å€‹ Job
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Discover Directories and Root Files
        id: set-matrix
        run: |
          # 1. æ‰¾å‡ºæ‰€æœ‰ç¬¬ä¸€å±¤çš„è³‡æ–™å¤¾ (æ’é™¤ .git, .github ç­‰éš±è—è³‡æ–™å¤¾)
          # ä½¿ç”¨ find æŒ‡ä»¤åªæ‰¾ç•¶å‰ç›®éŒ„ä¸‹çš„è³‡æ–™å¤¾
          DIRS=$(find . -maxdepth 1 -mindepth 1 -type d -not -path '*/.*' -printf '%P\n' | sort)
          
          # 2. è½‰æ›æˆ JSON é™£åˆ—
          # ä¾‹å¦‚: ["backend", "frontend", "terraform"]
          JSON_ARRAY=$(echo "$DIRS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          # 3. æª¢æŸ¥æ˜¯å¦æœ‰ã€Œæ ¹ç›®éŒ„æ•£è½æª”æ¡ˆã€(éè³‡æ–™å¤¾çš„æª”æ¡ˆ)
          ROOT_FILES=$(find . -maxdepth 1 -type f -not -path '*/.*' | head -n 1)
          
          if [ -n "$ROOT_FILES" ]; then
            echo "Found files in root directory. Adding _ROOT_FILES_ task."
            # æŠŠä¸€å€‹ç‰¹æ®Šçš„æ¨™è¨˜ "_ROOT_FILES_" åŠ é€²å»é™£åˆ—
            JSON_ARRAY=$(echo "$JSON_ARRAY" | jq -c '. + ["_ROOT_FILES_"]')
          fi
          
          echo "Final Matrix: $JSON_ARRAY"
          
          # 4. è¨­å®š Output è®Šæ•¸
          echo "matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT

  # ğŸš€ ç¬¬äºŒéšæ®µï¼šå¹³è¡Œæƒæ (æ¥æ”¶ä¸Šé¢çš„æ¸…å–®)
  cortex-scan-dynamic:
    needs: discover-targets  # å¿…é ˆç­‰æ¢ç´¢å®Œæˆ
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        # é€™è£¡æœƒè‡ªå‹•å¡«å…¥ä¸Šé¢æ‰¾åˆ°çš„æ¸…å–®ï¼Œä¾‹å¦‚ ["src", "tf", "_ROOT_FILES_"]
        target: ${{ fromJson(needs.discover-targets.outputs.matrix) }}

    name: Scan (${{ matrix.target }})
    
    permissions:
      contents: read
      pull-requests: read
      security-events: write
      actions: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Clean Config
        run: rm -rf ~/.cortexcli/APPSEC

      - name: Download cortexcli
        run: |
          set -eux
          crtx_resp=$(curl -sS "${CORTEX_API_URL}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" \
            -H "x-xdr-auth-id: ${CORTEX_API_KEY_ID}" \
            -H "Authorization: ${CORTEX_API_KEY}")

          crtx_url=$(echo "$crtx_resp" | jq -r ".signed_url")
          
          if [ -z "$crtx_url" ] || [ "$crtx_url" = "null" ]; then
            echo "Error: Failed to get signed URL"
            exit 1
          fi

          curl -sS -o cortexcli "$crtx_url"
          chmod +x cortexcli

      # ğŸŸ¢ æ™ºæ…§æƒæé‚è¼¯
      - name: Run Cortex CLI Code Scan
        run: |
          set -eux
          TARGET_NAME="${{ matrix.target }}"
          SCAN_DIR=""
          
          if [ "$TARGET_NAME" == "_ROOT_FILES_" ]; then
            echo "è™•ç†æ ¹ç›®éŒ„æ•£è½æª”æ¡ˆ..."
            # ğŸ’¡ æŠ€å·§ï¼šç‚ºäº†é¿å…æƒææ ¹ç›®éŒ„æ™‚ä¸å°å¿ƒåˆæƒé€²å»å­è³‡æ–™å¤¾ (é€ æˆé‡è¤‡èˆ‡è¶…æ™‚)
            # æˆ‘å€‘å»ºç«‹ä¸€å€‹æš«å­˜è³‡æ–™å¤¾ï¼ŒæŠŠæ ¹ç›®éŒ„çš„æª”æ¡ˆã€Œè¤‡è£½ã€é€²å»æƒæ
            mkdir -p _temp_root_scan
            find . -maxdepth 1 -type f -not -path '*/.*' -exec cp {} _temp_root_scan/ \;
            SCAN_DIR="_temp_root_scan"
            echo "å·²å°‡æ ¹ç›®éŒ„æª”æ¡ˆè¤‡è£½åˆ° $SCAN_DIR é€²è¡Œéš”é›¢æƒæ"
          else
            echo "è™•ç†è³‡æ–™å¤¾: $TARGET_NAME"
            SCAN_DIR="$TARGET_NAME"
          fi
          
          # åŸ·è¡Œæƒæ
          ./cortexcli \
            --api-base-url "${CORTEX_API_URL}" \
            --api-key "${CORTEX_API_KEY}" \
            --api-key-id "${CORTEX_API_KEY_ID}" \
            code scan \
            --directory "$SCAN_DIR" \
            --repo-id "${{ github.repository }}" \
            --branch "${{ github.ref_name }}" \
            --source "GITHUB_ACTIONS" \
            --create-repo-if-missing \
            --upload-mode upload \
            --scan-id-tag "$TARGET_NAME"
